(function(){
    // 文件名称: cm
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:02
// 描    述: 评论

    var cm = {};

    /**
     * 版本号
     * @type {number}
     */
    cm.VERSION = 1.0;

    /**继承**/
    cm.inherit = function(childClass,parentClass){
        childClass.prototype = Object.create(parentClass.prototype);
        childClass.prototype.constructor = childClass;
    };

    cm.id = (0|(Math.random()*998));

    cm.getNewID = function(){
        return cm.id++;
    };

    /**
     * 创建事件
     * @param type 事件类型
     * @param target 事件作用的对象
     * @returns {*|Event} 返回的事件可以由cm.EventDispatcher派发
     */
    cm.createEvent = function(type,target){
        var event = new cm.Event(type);
        event.target = target;
        return event;
    };

    /**
     * 获取一个指定范围随机数
     * @param min 范围最小值，包括min
     * @param max 范围最大值，不包括max
     * @returns {number}
     */
    cm.getRangeRandom = function(min,max){
        return Math.floor(min+Math.random()*(max-min));
    };

    /**
     * 判断对象是否是函数
     * @param value
     * @returns {boolean}
     */
    cm.isFunction = function(value) {
        return (typeof value) == "function";
    };

    /**
     * 判断对象是否是字符串
     * @param obj
     * @returns {boolean}
     */
    cm.isString = function(obj){ return typeof obj == 'string' };
    /**
     * 获取容器内随机的位置
     * @param size   Object {width: 640, height: 1008}
     */
    cm.getRandomPosition = function(size){
        var p = {};
        var tempWidth  = size.width - 83 - 170;    //减掉 弹幕开关离右边位置大小 头像大小，
        var tempHeight = size.height - 192-35;      //减掉 弹幕位置离顶部大小 减掉头像的一半
        p.x = tempWidth*Math.random() + 35;
        p.y = tempHeight*Math.random() + 90;
        return p;
    };
    /*
     去除数组的重复项
     */
    function uniqArr(arr){
        function toObject(a) {
            var o = {};
            for (var i=0, j=a.length; i<j; i=i+1) {
                o[a[i]] = true;
            }
            return o;
        };
        function keys(o) {
            var a=[], i;
            for (i in o) {
                if (o.hasOwnProperty(i)) { // 这里, YUI源码中是lang.hasOwnProperty(o, i)
                    a.push(i);
                }
            }
            return a;
        };
        return keys(toObject(arr));
    }

    window.cm = cm;
})();

// namespace:
window.cm = window.cm || {};

(function() {
	"use strict";

// constructor:
	/**
	 * Contains properties and methods shared by all events for use with
	 * {{#crossLink "EventDispatcher"}}{{/crossLink}}.
	 * 
	 * Note that Event objects are often reused, so you should never
	 * rely on an event object's state outside of the call stack it was received in.
	 * @class Event
	 * @param {String} type The event type.
	 * @param {Boolean} bubbles Indicates whether the event will bubble through the display list.
	 * @param {Boolean} cancelable Indicates whether the default behaviour of this event can be cancelled.
	 * @constructor
	 **/
	function Event(type, bubbles, cancelable) {
		
	
	// public properties:
		/**
		 * The type of event.
		 * @property type
		 * @type String
		 **/
		this.type = type;
	
		/**
		 * The object that generated an event.
		 * @property target
		 * @type Object
		 * @default null
		 * @readonly
		*/
		this.target = null;

        this.realTarget = null;
	
		/**
		 * The current target that a bubbling event is being dispatched from. For non-bubbling events, this will
		 * always be the same as target. For example, if childObj.parent = parentObj, and a bubbling event
		 * is generated from childObj, then a listener on parentObj would receive the event with
		 * target=childObj (the original target) and currentTarget=parentObj (where the listener was added).
		 * @property currentTarget
		 * @type Object
		 * @default null
		 * @readonly
		*/
		this.currentTarget = null;
	
		/**
		 * For bubbling events, this indicates the current event phase:<OL>
		 * 	<LI> capture phase: starting from the top parent to the target</LI>
		 * 	<LI> at target phase: currently being dispatched from the target</LI>
		 * 	<LI> bubbling phase: from the target to the top parent</LI>
		 * </OL>
		 * @property eventPhase
		 * @type Number
		 * @default 0
		 * @readonly
		*/
		this.eventPhase = 0;
	
		/**
		 * Indicates whether the event will bubble through the display list.
		 * @property bubbles
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.bubbles = !!bubbles;
	
		/**
		 * Indicates whether the default behaviour of this event can be cancelled via
		 * {{#crossLink "Event/preventDefault"}}{{/crossLink}}. This is set via the Event constructor.
		 * @property cancelable
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.cancelable = !!cancelable;
	
		/**
		 * The epoch time at which this event was created.
		 * @property timeStamp
		 * @type Number
		 * @default 0
		 * @readonly
		*/
		this.timeStamp = (new Date()).getTime();
	
		/**
		 * Indicates if {{#crossLink "Event/preventDefault"}}{{/crossLink}} has been called
		 * on this event.
		 * @property defaultPrevented
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.defaultPrevented = false;
	
		/**
		 * Indicates if {{#crossLink "Event/stopPropagation"}}{{/crossLink}} or
		 * {{#crossLink "Event/stopImmediatePropagation"}}{{/crossLink}} has been called on this event.
		 * @property propagationStopped
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.propagationStopped = false;
	
		/**
		 * Indicates if {{#crossLink "Event/stopImmediatePropagation"}}{{/crossLink}} has been called
		 * on this event.
		 * @property immediatePropagationStopped
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.immediatePropagationStopped = false;
		
		/**
		 * Indicates if {{#crossLink "Event/remove"}}{{/crossLink}} has been called on this event.
		 * @property removed
		 * @type Boolean
		 * @default false
		 * @readonly
		*/
		this.removed = false;
	}
	var p = Event.prototype;

	/**
	 * <strong>REMOVED</strong>. Removed in favor of using `MySuperClass_constructor`.
	 * See {{#crossLink "Utility Methods/extend"}}{{/crossLink}} and {{#crossLink "Utility Methods/promote"}}{{/crossLink}}
	 * for details.
	 *
	 * There is an inheritance tutorial distributed with EaselJS in /tutorials/Inheritance.
	 *
	 * @method initialize
	 * @protected
	 * @deprecated
	 */
	// p.initialize = function() {}; // searchable for devs wondering where it is.
	

// public methods:
	/**
	 * Sets {{#crossLink "Event/defaultPrevented"}}{{/crossLink}} to true.
	 * Mirrors the DOM event standard.
	 * @method preventDefault
	 **/
	p.preventDefault = function() {
		this.defaultPrevented = this.cancelable&&true;
	};

	/**
	 * Sets {{#crossLink "Event/propagationStopped"}}{{/crossLink}} to true.
	 * Mirrors the DOM event standard.
	 * @method stopPropagation
	 **/
	p.stopPropagation = function() {
		this.propagationStopped = true;
	};

	/**
	 * Sets {{#crossLink "Event/propagationStopped"}}{{/crossLink}} and
	 * {{#crossLink "Event/immediatePropagationStopped"}}{{/crossLink}} to true.
	 * Mirrors the DOM event standard.
	 * @method stopImmediatePropagation
	 **/
	p.stopImmediatePropagation = function() {
		this.immediatePropagationStopped = this.propagationStopped = true;
	};
	
	/**
	 * Causes the active listener to be removed via removeEventListener();
	 * 
	 * 		myBtn.addEventListener("click", function(evt) {
	 * 			// do stuff...
	 * 			evt.remove(); // removes this listener.
	 * 		});
	 * 
	 * @method remove
	 **/
	p.remove = function() {
		this.removed = true;
	};
	
	/**
	 * Returns a clone of the Event instance.
	 * @method clone
	 * @return {Event} a clone of the Event instance.
	 **/
	p.clone = function() {
		return new Event(this.type, this.bubbles, this.cancelable);
	};
	
	/**
	 * Provides a chainable shortcut method for setting a number of properties on the instance.
	 *
	 * @method set
	 * @param {Object} props A generic object containing properties to copy to the instance.
	 * @return {Event} Returns the instance the method is called on (useful for chaining calls.)
	 * @chainable
	*/
	p.set = function(props) {
		for (var n in props) { this[n] = props[n]; }
		return this;
	};

	/**
	 * Returns a string representation of this object.
	 * @method toString
	 * @return {String} a string representation of the instance.
	 **/
	p.toString = function() {
		return "[Event (type="+this.type+")]";
	};

	window.cm.Event = Event;
}());

window.cm = window.cm || {};

(function() {
	"use strict";

	function EventDispatcher() {
	
	
	// private properties:
		/**
		 * @protected
		 * @property _listeners
		 * @type Object
		 **/
		this._listeners = null;
		
		/**
		 * @protected
		 * @property _captureListeners
		 * @type Object
		 **/
		this._captureListeners = null;
	}
	var p = EventDispatcher.prototype;

	/**
	 * <strong>REMOVED</strong>. Removed in favor of using `MySuperClass_constructor`.
	 * See {{#crossLink "Utility Methods/extend"}}{{/crossLink}} and {{#crossLink "Utility Methods/promote"}}{{/crossLink}}
	 * for details.
	 *
	 * There is an inheritance tutorial distributed with EaselJS in /tutorials/Inheritance.
	 *
	 * @method initialize
	 * @protected
	 * @deprecated
	 */
	// p.initialize = function() {}; // searchable for devs wondering where it is.


// static public methods:
	/**
	 * Static initializer to mix EventDispatcher methods into a target object or prototype.
	 * 
	 * 		EventDispatcher.initialize(MyClass.prototype); // add to the prototype of the class
	 * 		EventDispatcher.initialize(myObject); // add to a specific instance
	 * 
	 * @method initialize
	 * @static
	 * @param {Object} target The target object to inject EventDispatcher methods into. This can be an instance or a
	 * prototype.
	 **/
	EventDispatcher.initialize = function(target) {
		target.addEventListener = p.addEventListener;
		target.on = p.on;
		target.removeEventListener = target.off =  p.removeEventListener;
		target.removeAllEventListeners = p.removeAllEventListeners;
		target.hasEventListener = p.hasEventListener;
		target.dispatchEvent = p.dispatchEvent;
		target._dispatchEvent = p._dispatchEvent;
		target.willTrigger = p.willTrigger;
	};
	

// public methods:
	/**
	 * Adds the specified event listener. Note that adding multiple listeners to the same function will result in
	 * multiple callbacks getting fired.
	 *
	 * <h4>Example</h4>
	 *
	 *      displayObject.addEventListener("click", handleClick);
	 *      function handleClick(event) {
	 *         // Click happened.
	 *      }
	 *
	 * @method addEventListener
	 * @param {String} type The string type of the event.
	 * @param {Function | Object} listener An object with a handleEvent method, or a function that will be called when
	 * the event is dispatched.
	 * @param {Boolean} [useCapture] For events that bubble, indicates whether to listen for the event in the capture or bubbling/target phase.
	 * @return {Function | Object} Returns the listener for chaining or assignment.
	 **/
	p.addEventListener = function(type, listener, useCapture) {
		var listeners;
		if (useCapture) {
			listeners = this._captureListeners = this._captureListeners||{};
		} else {
			listeners = this._listeners = this._listeners||{};
		}
		var arr = listeners[type];
		if (arr) { this.removeEventListener(type, listener, useCapture); }
		arr = listeners[type]; // remove may have deleted the array
		if (!arr) { listeners[type] = [listener];  }
		else { arr.push(listener); }
		return listener;
	};
	
	/**
	 * A shortcut method for using addEventListener that makes it easier to specify an execution scope, have a listener
	 * only run once, associate arbitrary data with the listener, and remove the listener.
	 * 
	 * This method works by creating an anonymous wrapper function and subscribing it with addEventListener.
	 * The created anonymous function is returned for use with .removeEventListener (or .off).
	 * 
	 * <h4>Example</h4>
	 * 
	 * 		var listener = myBtn.on("click", handleClick, null, false, {count:3});
	 * 		function handleClick(evt, data) {
	 * 			data.count -= 1;
	 * 			console.log(this == myBtn); // true - scope defaults to the dispatcher
	 * 			if (data.count == 0) {
	 * 				alert("clicked 3 times!");
	 * 				myBtn.off("click", listener);
	 * 				// alternately: evt.remove();
	 * 			}
	 * 		}
	 * 
	 * @method on
	 * @param {String} type The string type of the event.
	 * @param {Function | Object} listener An object with a handleEvent method, or a function that will be called when
	 * the event is dispatched.
	 * @param {Object} [scope] The scope to execute the listener in. Defaults to the dispatcher/currentTarget for function listeners, and to the listener itself for object listeners (ie. using handleEvent).
	 * @param {Boolean} [once=false] If true, the listener will remove itself after the first time it is triggered.
	 * @param {*} [data] Arbitrary data that will be included as the second parameter when the listener is called.
	 * @param {Boolean} [useCapture=false] For events that bubble, indicates whether to listen for the event in the capture or bubbling/target phase.
	 * @return {Function} Returns the anonymous function that was created and assigned as the listener. This is needed to remove the listener later using .removeEventListener.
	 **/
	p.on = function(type, listener, scope, once, data, useCapture) {
		if (listener.handleEvent) {
			scope = scope||listener;
			listener = listener.handleEvent;
		}
		scope = scope||this;
		return this.addEventListener(type, function(evt) {
				listener.call(scope, evt, data);
				once&&evt.remove();
			}, useCapture);
	};

	/**
	 * Removes the specified event listener.
	 *
	 * <b>Important Note:</b> that you must pass the exact function reference used when the event was added. If a proxy
	 * function, or function closure is used as the callback, the proxy/closure reference must be used - a new proxy or
	 * closure will not work.
	 *
	 * <h4>Example</h4>
	 *
	 *      displayObject.removeEventListener("click", handleClick);
	 *
	 * @method removeEventListener
	 * @param {String} type The string type of the event.
	 * @param {Function | Object} listener The listener function or object.
	 * @param {Boolean} [useCapture] For events that bubble, indicates whether to listen for the event in the capture or bubbling/target phase.
	 **/
	p.removeEventListener = function(type, listener, useCapture) {
		var listeners = useCapture ? this._captureListeners : this._listeners;
		if (!listeners) { return; }
		var arr = listeners[type];
		if (!arr) { return; }
		for (var i=0,l=arr.length; i<l; i++) {
			if (arr[i] == listener) {
//                console.log(type);
				if (l==1) {
//                    console.log(listeners[type])
                    delete(listeners[type]);
//                    console.log(listeners[type])
                } // allows for faster checks.
				else {
                    //console.log("len:" + arr.length);
                    arr.splice(i,1);
                    //console.log(dd);
                    //console.log(arr);

                }
				break;
			}
		}
        //arr.length = 0;
	};
	
	/**
	 * A shortcut to the removeEventListener method, with the same parameters and return value. This is a companion to the
	 * .on method.
	 *
	 * @method off
	 * @param {String} type The string type of the event.
	 * @param {Function | Object} listener The listener function or object.
	 * @param {Boolean} [useCapture] For events that bubble, indicates whether to listen for the event in the capture or bubbling/target phase.
	 **/
	p.off = p.removeEventListener;

	/**
	 * Removes all listeners for the specified type, or all listeners of all types.
	 *
	 * <h4>Example</h4>
	 *
	 *      // Remove all listeners
	 *      displayObject.removeAllEventListeners();
	 *
	 *      // Remove all click listeners
	 *      displayObject.removeAllEventListeners("click");
	 *
	 * @method removeAllEventListeners
	 * @param {String} [type] The string type of the event. If omitted, all listeners for all types will be removed.
	 **/
	p.removeAllEventListeners = function(type) {
		if (!type) { this._listeners = this._captureListeners = null; }
		else {
			if (this._listeners) { delete(this._listeners[type]); }
			if (this._captureListeners) { delete(this._captureListeners[type]); }
		}
	};

	/**
	 * Dispatches the specified event to all listeners.
	 *
	 * <h4>Example</h4>
	 *
	 *      // Use a string event
	 *      this.dispatchEvent("complete");
	 *
	 *      // Use an Event instance
	 *      var event = new createjs.Event("progress");
	 *      this.dispatchEvent(event);
	 *
	 * @method dispatchEvent
	 * @param {Object | String | Event} eventObj An object with a "type" property, or a string type.
	 * While a generic object will work, it is recommended to use a CreateJS Event instance. If a string is used,
	 * dispatchEvent will construct an Event instance with the specified type.
	 * @return {Boolean} Returns the value of eventObj.defaultPrevented.
	 **/
	p.dispatchEvent = function(eventObj) {
		if (typeof eventObj == "string") {
			// won't bubble, so skip everything if there's no listeners:
			var listeners = this._listeners;
			if (!listeners || !listeners[eventObj]) { return false; }
			eventObj = new window.cm.Event(eventObj);
		} else if (eventObj.realTarget && eventObj.clone) {
			// redispatching an active event object, so clone it:
			eventObj = eventObj.clone();
		}
		try { eventObj.realTarget = this; } catch (e) {} // try/catch allows redispatching of native events

		if (!eventObj.bubbles || !this.parent) {
			this._dispatchEvent(eventObj, 2);
		} else {
			var top=this, list=[top];
			while (top.parent) { list.push(top = top.parent); }
			var i, l=list.length;

			// capture & atTarget
			for (i=l-1; i>=0 && !eventObj.propagationStopped; i--) {
				list[i]._dispatchEvent(eventObj, 1+(i==0));
			}
			// bubbling
			for (i=1; i<l && !eventObj.propagationStopped; i++) {
				list[i]._dispatchEvent(eventObj, 3);
			}
		}
		return eventObj.defaultPrevented;
	};

	/**
	 * Indicates whether there is at least one listener for the specified event type.
	 * @method hasEventListener
	 * @param {String} type The string type of the event.
	 * @return {Boolean} Returns true if there is at least one listener for the specified event.
	 **/
	p.hasEventListener = function(type) {
		var listeners = this._listeners, captureListeners = this._captureListeners;
		return !!((listeners && listeners[type]) || (captureListeners && captureListeners[type]));
	};
	
	/**
	 * Indicates whether there is at least one listener for the specified event type on this object or any of its
	 * ancestors (parent, parent's parent, etc). A return value of true indicates that if a bubbling event of the
	 * specified type is dispatched from this object, it will trigger at least one listener.
	 * 
	 * This is similar to {{#crossLink "EventDispatcher/hasEventListener"}}{{/crossLink}}, but it searches the entire
	 * event flow for a listener, not just this object.
	 * @method willTrigger
	 * @param {String} type The string type of the event.
	 * @return {Boolean} Returns `true` if there is at least one listener for the specified event.
	 **/
	p.willTrigger = function(type) {
		var o = this;
		while (o) {
			if (o.hasEventListener(type)) { return true; }
			o = o.parent;
		}
		return false;
	};

	/**
	 * @method toString
	 * @return {String} a string representation of the instance.
	 **/
	p.toString = function() {
		return "[EventDispatcher]";
	};


// private methods:
	/**
	 * @method _dispatchEvent
	 * @param {Object | String | Event} eventObj
	 * @param {Object} eventPhase
	 * @protected
	 **/
	p._dispatchEvent = function(eventObj, eventPhase) {
		var l, listeners = (eventPhase==1) ? this._captureListeners : this._listeners;
		if (eventObj && listeners) {
			var arr = listeners[eventObj.type];
			if (!arr||!(l=arr.length)) { return; }
			try { eventObj.currentTarget = this; } catch (e) {}
			try { eventObj.eventPhase = eventPhase; } catch (e) {}
			eventObj.removed = false;
			
			arr = arr.slice(); // to avoid issues with items being removed or added during the dispatch
			for (var i=0; i<l && !eventObj.immediatePropagationStopped; i++) {
				var o = arr[i];
				if (o.handleEvent) { o.handleEvent(eventObj); }
				else { o(eventObj); }
				if (eventObj.removed) {
					this.off(eventObj.type, o, eventPhase==1);
					eventObj.removed = false;
				}
			}
		}
	};

	window.cm.EventDispatcher = EventDispatcher;
}());

// 文件名称: cm.BaseView
//
// 创 建 人: chenshy
// 创建日期: 2015/9/2 0:19
// 描    述: cm.BaseView
(function(cm){
    var BaseView = function(){
        cm.EventDispatcher.call(this);
    };

    cm.inherit(BaseView,cm.EventDispatcher);

    cm.BaseView = BaseView;
})(cm);
// 文件名称: cm.ObjectPoolFactory
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:27
// 描    述: cm.ObjectPoolFactory
(function(cm){
    cm.objectPoolFactory = function(createObjFn){
        return {
            objectPool : [],
            create : function(){
                var objectPool = this.objectPool;
                //console.log(objectPool.length,"length");
                var obj = (objectPool.length === 0 ? createObjFn.apply(this,arguments)
                    : objectPool.shift());
                return obj;
            },
            recover : function(obj){
                this.objectPool.push(obj);
            }
        };
    };

})(cm);
// 文件名称: cm.barrageFadeAnimation
//
// 创 建 人: chenshy
// 创建日期: 2015/9/1 21:13
// 描    述: 评论消息的显示动画
(function(cm){
    cm.barrageFadeAnimation = function(messageView,bool){
        var msgs = this._showMessagePool;

        if(bool){
            for(var i = msgs.length - 1;i >= 0;i--) {
                var $dom = msgs[i].$dom;
                $dom.off("webkitAnimationEnd animationEnd");
                $dom.removeClass("comment-msg-fade");
            }
        }else{
            if(msgs.length >= this._showCount){
                var view = msgs[0];

                view.$dom.removeClass("comment-msg-show");

                view.$dom.on("webkitAnimationEnd animationEnd",function(){
                    view.$dom.off("webkitAnimationEnd animationEnd");
                    view.dispatchEvent("message:animation:end");
                });
                 view.$dom.addClass("comment-msg-fade");
            }
        }

    };

    function getMsg(msgs){
        var view,len = msgs.length,i = 0,temp;
        while(!view && i < len){
            temp = msgs[0];
            if(!temp.animating){
                view = temp;
            }else{
                i++;
            }
        }
        return view;
    }

    //左移动画
    cm.barrageMoveAnimation = function(messageView,bool){
        var msgs = this._showMessagePool;

        //if(bool){
            //for(var i = msgs.length - 1;i >= 0;i--) {
            //    var $dom = msgs[i].$dom;
                this.$dom.off("webkitAnimationEnd animationEnd");
            //}
        //}else{
        //    var view = getMsg(msgs);
        //    if(view){
        //        console.log("anim-" + view.id);
        //        view.animating = true;
        //        view.$dom.on("webkitAnimationEnd animationEnd",function(){
        //            view.$dom.off("webkitAnimationEnd animationEnd");
        //            view.animating = true;
        //            console.log("dispath-" + view.id);
        //            view.dispatchEvent("message:animation:end");
        //        });
        //    }
        //}

    }
})(cm);
// 文件名称: cm.Const
//
// 创 建 人: chenshy
// 创建日期: 2015/9/8 14:01
// 描    述: cm.Const
cm.Const = {

	defaultUserPic: "http://ac-hf3jpeco.clouddn.com/8c665e1f11f2fbe1c59d"
};

// 文件名称: animationCss.js
//
// 创 建 人: chenshy
// 创建日期: 2015/9/1 22:46
// 描    述: 动画css文件
(function(){
    var cssArr = [];

    cssArr.push(
        "@-webkit-keyframes comment-msg-fade-frame {" +
            //"0%{opacity:0}" +
            "0%{opacity:1}" +
            "88%{opacity:1}" +
            "100%{opacity:0}" +
        "}"
    );
    cssArr.push(
        "@keyframes comment-msg-fade-frame {" +
        //"0%{opacity:0}" +
        "0%{opacity:1}" +
        "88%{opacity:1}" +
        "100%{opacity:0}" +
        "}"
    );


    cssArr.push(
        "@-webkit-keyframes comment-msg-show-frame {" +
            "0%{opacity:0}" +
            "100%{opacity:1}" +
        "}"
    );
    cssArr.push(
        "@keyframes comment-msg-show-frame {" +
            "0%{opacity:0}" +
            "100%{opacity:1}" +
        "}"
    );

    cssArr.push(
        ".comment-msg-fade{" +
            "-webkit-animation-name: comment-msg-fade-frame;" +
            "animation-name: comment-msg-fade-frame; " +
            "-webkit-animation-duration: 2s;" +
            "animation-duration: 2s;" +
            "-webkit-animation-fill-mode: both;" +
            "animation-fill-mode: both;" +
        "}"
    );
//cubic-bezier(.55,.77,.49,.01);
    cssArr.push(
        ".comment-msg-show{" +
        "-webkit-animation-name: comment-msg-move-frame;" +
        "animation-name: comment-msg-move-frame; " +
        "-webkit-animation-duration:5s;" +
        "animation-duration: 5s;" +
        "animation-iteration-count:1;"+
        "-webkit-animation-iteration-count:1;"+ 
        "animation-timing-function:cubic-bezier(.55,.77,.49,.01);"+
        "-webkit-animation-timing-function:cubic-bezier(.55,.77,.49,.01);"+
        "-webkit-animation-fill-mode: both;" +
        "animation-fill-mode: both;" +
        "}"
    );

   //动画左移
   cssArr.push(
        "@-webkit-keyframes comment-msg-move-frame{" + 
            "0%{-webkit-transform: translate3d(200%, 0, 0); }"+
            "100%{-webkit-transform: translate3d(-200%, 0, 0);}"+
        "}"
    ); 
    //暂停动画
    cssArr.push(
         ".animation-paused{" + 
             "animation-play-state:paused;"+
             "-webkit-animation-play-state:paused;"+
        "}"
    );

    //继续播放动画
    cssArr.push(
         ".animation-run{" + 
             "animation-play-state:running;"+
             "-webkit-animation-play-state:running;"+
        "}"
    );

 

    if(!document.getElementById('style-comment-animation')){
        var styleNode = document.createElement("style");
        styleNode.type = "text/css";
        styleNode.id = "style-comment-animation";
        styleNode.innerHTML = cssArr.join("");
        document.head.appendChild(styleNode);
    }

    
})();
// 文件名称: css.js
//
// 创 建 人: chenshy
// 创建日期: 2015/9/1 11:25
// 描    述: css.js
(function(){
    var cssArr = [];

    cssArr.push(
        ".comment-message{" +
            "position: absolute;"+
            "width: 60%;"+
            "height: auto;"+
            "white-space: nowrap;"+
            "font-size: 0;"+
            "color: #fff;"+
//            "pointer-events: auto;"+
        "}"
    );

//.comment-message-photo
 
//.comment-message-photo
    cssArr.push(
        ".comment-message-photo{" +
            "width: 70px;"+
            "height: 70px;"+
            "border: 2px solid rgba(0,0,0,.2);"+
            "border-radius: 50%; "+
            "overflow:hidden;"+
        "}");

    cssArr.push(
        ".comment-message-photo img{" +
            "width: 100%;"+
            "height: 100%;"+
        "}");

    //.comment-message-content
    cssArr.push(
        ".comment-message-content{" +
            "max-width: -webkit-calc(100% - 80px);"+
            "max-width: calc(100% - 80px);"+
            "text-align: justify;"+
            "white-space: pre-line;"+
            "padding: 15px 20px;"+
            "min-height: 70px;"+
            "font-size: 26px;"+
            "white-space:normal;"+
            "word-wrap:break-word;"+
            "border-radius: 40px;"+
            "background-color: rgba(0,0,0,0.5);" +
            "box-sizing: border-box;"+
        "}");

    cssArr.push(
        ".comment-message-left .comment-message-photo{" +
             "float:left; "+
             "margin-right:8px;"+
        "}"
    );

    cssArr.push(
        ".comment-message-left .comment-message-content{" +
            "float:left; "+
        "}"
    );

    cssArr.push(
        ".comment-message-right .comment-message-photo{" +
            "float:right; "+
            "margin-left:8px;"+
        "}"
    );

    cssArr.push(
        ".comment-message-right .comment-message-content{" +
            "float:right; "+
        "}"
    );

    cssArr.push("" +
        ".comment-reply-container{" +
            "position:fixed;" +
            "width:100%;" +
            "height:90px;" +
            "left:0;bottom:0;" +
            "background:#f2f2f2;" +
            "z-index:100005;" +
        "}");

    cssArr.push(
        ".comment-reply-txt{" +
            "position:relative;" +
            "display:table;" +
            "width:100%;height:100%;" +
            "text-align:center;" +
            "font-size:18px;" +
        "}");

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-table-cell:nth-child(1){" +
            "width:15%;display:none" +
        "}"
    );

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-table-cell:nth-child(2){" +
        "padding-left:15px;" +
        "}"
    );

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-table-cell:nth-child(3){" +
        "color:#666;" +
        "}"
    );

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-table-cell{" +
            "vertical-align:middle;" +
        "}"
    );

    cssArr.push(
        ".comment-table-cell{" +
            "height:100%;" +
            "font-size:26px;" +
            "color:#FFF;" +
            "display:table-cell;" +
        "}"
    );

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-reply-input{" +
            "display:inline-block;" +
            "width:100%;height:60px;" +
            "padding:10px 10px;" +
            "word-break:break-all;" +
            "word-wrap:break-word;" +
            "border:1px solid #ccc;" +
            "text-align:left;" +
            "border-radius:10px;" +
            "color:#000;" +
            "font-size:24px;" +
            "box-sizing:border-box;" +
        "}"
    );

    cssArr.push(
        ".comment-reply-container .comment-reply-txt .comment-sent-btn{" +
            "display: inline-block;"+
            "height: 100%;"+
            "width: 50px;"+
            "background-color: transparent;"+
        "}"
    );
    cssArr.push(
        ".comment-reply-container .comment-reply-txt .cno-send-btn{" +
        "background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABpFBMVEUAAACZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZkAAAA7MdpSAAAAinRSTlMAFlePt9jt+BNxy/4ZjfT8xoRVLRQHK1OBxPv1kxoEdfPadxJszwUlzttbAwFLKk/xgAgCbVBm3jRpvRGqTrScKQao0N0QCsz3MiHydn6UlfZYCUZw19VzrBVlq/rJjIWpjqe2kDVJpTmao5JNofmfluyemJ2Cm1wXl3JrJCauUc16exvDfxy42e5G1hkjAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAALEgAACxIB0t1+/AAAArJJREFUSMeNlglX00AQxwdSjrZqBdMWUCBYekAKhhZQEJSKEKUKreCFVcEL8RZRUTxQUeD/qZ2GHmmao/Nem53Z3+zLbuZYIqPU1QuuhsampsYGl1BfRw7S7PZ4oROvx91sgx85egzwHW9pPSH6/WIg2NbeAZw81WmBd3VLQM/piulQbxiQuiNmfDQG9PXLRnN8gO3hwWr+jIKmoYTZSslhBdKI0Trqw9lzVnuLhuEbrTSNAePnrU8jMQGM6Q2TPlzw2x23fBG+ybI6JWE8RbYiX4I0VVQi07g8Qw4yq2K6eLrduHLViSeaS+Pa4ahTwnVnnqgX0uFHnUeDvxYHWcVC/ilmkLXj4oM3CqNFZER+LOFm0oZPTeBWV2EcwxL/q7htw0fucIzfLSjL8HC+eH02WdJ1j5OipajN5LydlMV9m31ySOBBWW9HPwl4aM2vML+qM7RBIBdaLflHzAt6SxCPqQ8BO/5JXG8KoI/SKIX102f6WXmtiicRaQKK2nMv1svz8gvmX1bylGK67PCKiZKH/Jq1eQPPDm90rxR/W/aQ8+N3Rp5f6b1+03LJI7nBow9VvLZpF4Jk9Ihv6t/OcKwCPpLBI5nnP5nw2ofLop0MHj38u2jGc2h8pi1vbsboAWya8lrwcXgvk9FjwzxDlqFSPoFiFVb5S25dNuU5gb6SlqKLVJMUUpQWoMq18LLnsAjky8x2LQ7bxTLDhUz55szPKcVCRpEYYrNOfMKDWKkRRRWsOWyDsyP9vaxyud+09TCUe62h/EhY84kVQ0PRWlY4asWbtCyiEQXKsGlEJLe5Kf40WYbb685AtX1gB5geNFsp9SvDHbk3pLdpjT3z26qf/Vnlq0PH7lAwEEqlQoHg39381WH+n83xiW618nKiukVykK2ssLd/kMsd7O8J2a2q6f8PCsjdTvE4ewAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNS0wOC0yMVQxNTozOToyMiswODowMLfclckAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTUtMDgtMjFUMTU6Mzk6MjIrMDg6MDDGgS11AAAAAElFTkSuQmCC') center center no-repeat;"+
        "}"
    );
    cssArr.push(
        ".comment-reply-container .comment-reply-txt .cyes-send-btn{" +
        "background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABRFBMVEUAAAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAD/zAH/1Cr/zgn/zQb/7qr/////99X/zQT/zQX/7qz///7/0BX/7qv/5oT/zQP/6Iz/7qn/6I7/7af/6Y//6ZD/1zX/20n/7aX/1zn/65r/7aP/6ZL/203/7KH/6pT/7J//6pb/zAL/7J7/6pj/653/65v/+Nr/65z/6pf//voAAABbdXPBAAAAQHRSTlMAFlePt9jt+BNxy/4ZjfT1kxoEdfMFJc7PKk/xUGb8aU4p0HaUlRT2cMxYW7bb8vnsXBdyJlEGensbjhy42e76B63O0wAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxIAAAsSAdLdfvwAAAHZSURBVEjHnZYHU8IwFMefFFGoCwFxMBQFBBUVtyI8HHFb9564/f4fwABHm7ZpWvzf5S4v+f3vsl8AjGpxSe5WT1ubp9UtuVrARu1en4yMZJ+3XYB3dHahSd09fgu8NxBEroKBEI/vC6Ol+gfM/OAQChSMGPloDIWKRfV8HG0VZ/nhmL0hNqzxI0F7ns5jpMGHEk54xERjdQPOeMTROu93NKDaoOp7PuaUR0xW+VRaDJU3NtV6OkUN42J+a5vs7KrRODVkhPzePiEHh2roo/dFFvG7R4SQYy2W/ZAV8co25U/YlgmQRPwp5c90TRK4Bfw55S/0bZMwJeYvy/rGKchpwdU126vccHjMgVa/PSB3Wr9yT/kHI4/IGB4poTqUJxo9m/lpZkjlF82hVOuvZh5n2EkrqqPyRmvvHJ5Oml3WhqP8wY7OsKy6jas7KlX+k8vTjdMfjZrji5ZvPo+zkJfNDkI+LHh6+IzHu+Z4q/B5zHAukPLze6dY8Djn4Iqyql1RSDo3JP/3zDT9kEEo7IwPq4mob8gJn5v//3PffEJpPmUBRMRJcaG5tJvgpF2AxSWLQ5JeXrT4C6ys8r4OY2tgrZQ3o/+cZLwpsFE+KxXWi6VScb0gZfOm7j9/FMZAyfJwSgAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNS0wOC0yMVQxNTozOToyMyswODowMBGrnn0AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTUtMDgtMjFUMTU6Mzk6MjMrMDg6MDBg9ibBAAAAAElFTkSuQmCC') center center no-repeat;"+
        "}"
    );
    cssArr.push(
        ".comment-mask-parent{" +
            "position:absolute;" +
            "left:0;top:0;" +
            "width:100%;height:100%;" +
            "z-index:100002;" +
            "background:rgba(0,0,0,0.5);" +
            "overflow:hidden;" +
        "}"
    );

    cssArr.push(
        ".comment-ocbalert{" +
            "width:100%;height:88px;" +
            "background:#000;" +
            "position:absolute;left:0;bottom:0;" +
        "}"
    );

    cssArr.push(
        ".ocbalert-ok,.ocbalert-cancel{" +
            "font-size:28px;color:#ffffff;" +
            "width:50%;height:100%;display:inline-block;" +
            "text-align:center;line-height:88px;" +
        "}"
    );

    cssArr.push(
        ".comment-barrage-container{" +
            "position:absolute;" +
            "pointer-events: none;"+
            "width:100%;height:100%;" +
            "overflow:hidden;"+
        "}"
    );
if(!document.getElementById('style-comment')){
     var styleNode = document.createElement("style");
    styleNode.type = "text/css";
    styleNode.id = "style-comment";
    styleNode.innerHTML = cssArr.join("");
    document.head.appendChild(styleNode);
}
   

    cssArr.length = 0;
    cssArr = null;
})();

// 文件名称: CommentModel
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 17:34
// 描    述: CommentModel
(function(cm){
    var commentModel = {};

    commentModel.getCommentList = function(options,cbOk,cbError){
        var comment_type = options.commentType || 0,
            comment_id = options.tplPageId, //页id
            orderby = options.orderBy || "createdAt",
            isdesc = options.isDesc === undefined ? true : options.isDesc,
            pageSize = options.pageSize,
            pageNumber = options.pageNumber;

        var skip = 0;
        var limit=pageNumber;
        //比如要看第 10 页，每页 10 条   就应该是 skip 90 ，limit 10
        if (pageSize != 0) {
            skip = pageSize * pageNumber ;
        }

        if (!comment_id){
            cbError();
            return
        }

        var strCQL = " select include comment_uid_pointer.user_nick,comment_uid_pointer.user_pic,comment_content,comment_uid from me_comment where  comment_state=0 and comment_display=0 ";

        //if (comment_type.length>0&&comment_id.length>0) {
        if (comment_type == 0) {
            strCQL += " and  belong_tpl='" + comment_id + "'";
        }
        else if (comment_type==1) {
            strCQL += " and  belong_tplpage='" + comment_id + "'";
        }
        else if (comment_type == 2) {
            strCQL += " and  belong_comment='" + comment_id + "'";
        }

        //排序
        if (isdesc) {
            strCQL += " order by " + orderby + " desc ";
        } else {
            strCQL += " order by " + orderby + " asc ";
        }

        //翻页
        if (skip >= 0 && limit > 0) {
            strCQL += " limit " + skip + "," + limit;
        }

        fmacloud.Query.doCloudQuery(strCQL, {
            success: function(data){
                cbOk(data);
            },
            error: function(data){
                cbError(data);
            }
        });
    };

    /**
     * 回复评论
     * @param options
     * option.comment_id 页id或评论id
     * option.comment_type 当前作品的类型 0-微杂志作品，1-众创页评论，2-评论
     * option.comment_content  评论的内容
     * option.data_site, 来源：0-ME App; 1-PC端;2-微信 默认0
     * option.belong_comment 评论id,如果comment_id为评论id,刚此属性为评论id,否则为空
     * option.belong_tpl 作品id
     * option.belong_tplpage 作品页id
     *
     * @param cbOk
     * @param cbError
     */
    commentModel.replyComment = function(options,cbOk,cbError){
        var user = this.getCurrentUser();
        if(!user){
            return;
        }
        options.comment_uid = user.id;
        options.data_site = options.data_site || 0;
        var self = this;
        sns_data.snsSaveComment(options,function(data){
            self._opCommentCount(options.comment_id,1);
            if(cbOk) cbOk(data);
        },function(error){
            if(cbError) cbError(error);
            console.log("评论失败,错误信息" , error)
        })
    };

    /**
     * 缓存点赞数
     */
    var praiseCountCache = {};

    /**
     * 获取点赞数量
     * @param id
     * @param cb
     */
    commentModel.getPraiseCount = function(id,cb){
        if(praiseCountCache[id]){
            cb(praiseCountCache[id]);
            return;
        }
        sns_data.getSnsLikeCount(id,function(count){
            praiseCountCache[id] = count;
            cb(count);
        },function(error){
            cb(0);
        });
    };

    commentModel._opPraiseCount = function(id,num){
        if(praiseCountCache[id]){
            praiseCountCache[id] = praiseCountCache[id] + num;
        }
    };


    /**缓存评论数量**/
    var commentCountCache = {};

    /**
     * 获取评论数量
     * @param fieldName
     * @param id
     * @param cb
     */
    commentModel.getCommentCount = function(fieldName,id,cb){
        if(commentCountCache[id]){
            cb(commentCountCache[id]);
            return;
        }
        sns_data.getSnsCommentCountByCid(fieldName,id,function(count){
            commentCountCache[id] = count;
            cb(count);
        },function(){
            cb(0);
        });
    };

    commentModel._opCommentCount = function(id,num){
        if(commentCountCache[id]){
            commentCountCache[id] = commentCountCache[id] + num;
        }
    };

    /**
     * 缓存点赞列表
     * @type {{}}
     */
    var praisesCaches = {};

    /**
     * 获取当前用户的所有点赞
     * @param id
     * @param cb
     */
    commentModel.getCurrentUserPraises = function(id,cb){
        var user = this.getCurrentUser();
        var key = user.id + "-" + id;
        if(praisesCaches[key]){
            cb(praisesCaches[key]);
            return;
        }
        sns_data.getSnsLike(user.id, id, "", "", "", "", function(arr){
            praisesCaches[key] = arr;
            cb(arr);
        }, function(){
            cb([]);
        });
    };

    /**
     * 获取点赞状态
     * @param id
     * @param cb
     */
    commentModel.getPraiseStatus = function(id,cb){
        //like_tplid
        this.getCurrentUserPraises(id,function(arr){
            var bool = false;
            for(var i = 0;i < arr.length;i++){
                var o = arr[i];
                if(o.get("like_tplid") == id){
                    bool = true;
                    break;
                }
            }
            cb(bool);
        });
    };

    commentModel._deletePraiseStatus = function(id){
        var user = this.getCurrentUser();
        var key = user.id + "-" + id;
        if(praisesCaches[key]){
            var arr = praisesCaches[key];
            for(var i = arr.length - 1;i >= 0;i--){
                var o = arr[i];
                if(o.get("like_tplid") == id){
                    arr.splice(i,1);
                }
            }
        }
    };

    commentModel._addPraiseStatus = function(id,data){
        var user = this.getCurrentUser();
        var key = user.id + "-" + id;

        if(praisesCaches[key]){
            praisesCaches[key].push(data);
        }

        //console.log(praisesCaches[key] );
    };

    /**
     *
     * @param param
     * param.id
     * param.tplType 作品类型 0-微杂志作品，1-众创页点赞，2-评论，3-拓展后续添加
     * param.dataSite 来自哪个终端 0-ME App; 1-PC端;2-微信
     * param.commentId 回复评论id
     * param.tplId 作品id
     * param.commentUid
     * @param cbOk
     * @param cbError
     */
    commentModel.praise = function(param,cbOk,cbError){
        var likeStatus = "cancerlike";

        var self = this;
        this.getPraiseStatus(param.id,function(bool){
            //console.log("status:" + bool);
            likeStatus = bool ? "cancerlike" : "like";
            var option = {
                "like_opration":likeStatus,
                "like_type":param.tplType,
                "like_tplid":param.id,
                "belong_tpl":param.tplId,
                //TODO comment_uid? objectId?
                "belong_tplpage":param.pageid,
                "belong_comment":param.commentUid,
                "data_site":param.dataSite
            };
            //console.log(option);
            sns_data.snsSaveLike(option,function(p){
                //console.log(p);
                if(likeStatus == 'cancerlike'){
                    self._deletePraiseStatus(param.id);
                    self._opPraiseCount(param.id,-1);
                }else{
                    self._addPraiseStatus(param.id, p);
                    self._opPraiseCount(param.id,1);
                }
                cbOk(likeStatus,p);
            },function(){
                cbError && cbError();
            });
        });
    };

    /**
     * 消息推送
     */
    commentModel.msgPush = function(option,cbOk,cbError){
        sns_data.msgAdd(option,function(p){
            cbOk(p);
        },function(){
            if(cbError){
                cbError();
            }
        });
    };


    commentModel.getCurrentUser = function(){
        return sns_data.getCurrentUser();
    };

    cm.commentModel = commentModel;
})(cm);
// 文件名称: cm.BarrageView
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 16:33
// 描    述: cm.BarrageView
(function (cm) {

    function getCreateDelayTime() {
        return 1000;
    }

    /**
     * 弹幕容器视图对象
     * @param comment
     * @constructor
     */
    var BarrageView = function (comment) {
        cm.EventDispatcher.call(this);
        this.comment = comment;
        /**
         * 弹幕上最多显示的消息数量
         * @type {number}
         * @private
         */
        this._showCount = 5;
        var container = this.dom = this.comment.barrageContainer;
        this.$dom = $(this.dom);

        this._isShow = false;

        /**
         * 当前数据页索引
         * @type {number}
         */
        this._currentIndex = 0;

        /**
         * 评论索引
         * @type {number}
         * @private
         */
        this._commentIndex = 0;
        this._tempCommentIndex = 0;

        /**
         * 存放的消息数据集合
         * @type {Array}
         * @private
         */
        this._commentDataList = [];

        /**
         * 当前是否处于数据加载状态
         * @type {boolean}
         * @private
         */
        this._isDataLoading = false;

        /**
         * 当前的消息评论池
         * @type {Array}
         * @private
         */
        this._showMessagePool = [];

        /**
         * 数据是否加载完成，服务器上已经没有数据
         * @type {boolean}
         * @private
         */
        this._loadOver = false;

        this._timer = null;

        /**弹幕是否暂停**/
        this._paused = false;

        /**
         * 弹幕上评论消息的动画函数
         */
            //this.animationFn = cm.barrageMoveAnimation;

        this.$dom.css({
            //  position : "absolute",
            zIndex: 100000,
            width: container.style.width,
            height: container.style.height
        });
    };

    cm.inherit(BarrageView, cm.EventDispatcher);

    var p = BarrageView.prototype;

    /**
     * 显示弹幕评论
     */
    p.show = function () {
        if (this._isShow) {
            return;
        }

        this.start();

        this._addEvent();

        this._isShow = true;
        //console.log("hah");
        this.$dom.show();
        this.createMessage();
    };

    /**
     * 从服务器获取数据
     * @param fn
     * @private
     */
    p._getCommentData = function (fn) {
        //debugger;
        var list = this._commentDataList;
        var cIndex = this.commentIndex;
        var f = fn, data = this._commentDataList;
        var self = this;
        //console.log("GG");
        // console.log("this._loadOver",this._loadOver);
        // console.log("commentIndex",this.commentIndex);
        if (!this._loadOver) {
            // console.log("commentIndex",this.commentIndex);
            if (list.length - 1 - cIndex < 5) {
                if (cIndex <= list.length - 1) {
                    f(list[cIndex]);
                    this.commentIndex++;
                    f = null;
                }

                if (!this._isDataLoading) {
                    this._isDataLoading = true;
                    var index = this._currentIndex;
                    //console.log("查询。。。。");

                    cm.commentModel.getCommentList(
                        {
                            pageNumber: index,
                            pageSize: 1000,
                            tplPageId: this.comment.tplId
                        },
                        function (data) {
                            if (data.results.length > 0) {
                                self._commentDataList = list.concat(data.results);

                                if (f && self._commentDataList && self._commentDataList.length > 0) {
                                    f(self._commentDataList[cIndex]);
                                    self.commentIndex++;
                                }
                            } else {
                                self._loadOver = true;
                            }
                            //TODO 暂时一次加载所有
                            self._loadOver = true;
                            self._isDataLoading = false;
                            f = null;
                        },
                        function () {
                            self._isDataLoading = false;
                        }
                    );
                }
            } else {
                //console.log(data[cIndex],cIndex);
                f(data[cIndex]);
                this.commentIndex++;
            }
        } else {
            if (this._commentDataList.length >= 1) {
                //var rd;

                //console.log(this._tempCommentIndex);

                if (this._tempCommentIndex > this._commentDataList.length - 1) {
                    this._tempCommentIndex = 0;
                }
                //do{
                //    rd = cm.getRangeRandom(0,this._commentDataList.length);
                //}while(this._tempCommentIndex == rd);
                //
                //this._tempCommentIndex = rd;
                // console.log(this._commentDataList.length,this._tempCommentIndex);
                fn(this._commentDataList[this._tempCommentIndex]);
                this._tempCommentIndex++;
            }
        }
    };

    Object.defineProperty(p, "commentIndex", {
        get: function () {
            return this._commentIndex;
        },
        set: function (value) {
            this._commentIndex = value;
            this._tempCommentIndex = value;
        }
    });

    /**
     * 隐藏弹幕
     */
    p.hide = function () {
        if (!this._isShow) {
            return;
        }
        this._isShow = false;
        this._removeEvent();
        this.$dom.hide();
        //if(this.dom.parentNode){
        //    this.dom.parentNode.removeChild(this.dom);
        //}
    };

    p._addEvent = function () {
        var self = this;
        this.$dom.on("tap", function (e) {
            e.preventDefault();
            e.stopPropagation();
            self._checkClickMsg(e);
        });
    };

    /*
     * 当点击弹幕上的容器时，判断点击的对象
     * @param e
     * @private
     */
    p._checkClickMsg = function (e) {
        var comment = this.comment;
        if (comment.lockBarrageEvent) {
            return;
        }
        var target = e.target;
        var pool = this._showMessagePool;
        var msg;
        for (var i = pool.length - 1; i >= 0; i--) {
            msg = pool[i];
            //console.log(msg.$dom.find(target)[0]);
            //点击的是评论消息对象
            if (msg.dom === target || msg.$dom.find(target)[0]) {
                break;
            }
            msg = null;
        }


        //创建弹幕点击事件
        var event = cm.createEvent("barrage:click", target);
        //console.log(event);
        var data = null;
        if (msg) {
            data = msg.getMessageData();
            //如果点击的是评论消息对象，则target为评论消息的容器，否则为弹幕容器
            //event.target = msg.dom.getElementsByClassName("comment-message-content");
            event.target = msg.dom;
            // console.log(event.target);
            comment.selectedTarget = msg.dom;
        } else {
            //this.comment.showReply();
            comment.selectedTarget = target;
        }

        //如果点击的是评论消息对象，则data为评论消息的messageData,否则为空
        event.data = data;

        comment.selectedData = data;

        comment.dispatchEvent(event);
    };

    p._removeEvent = function () {
        this.$dom.off("tap");
    };

    /**
     * 创建评论消息，调用此方法时，会判断评论消息对象池数量是否达到显示数量
     * 如果不足，则继续创建
     */
    p.createMessage = function () {
        if (this._paused) {
            return;
        }

        var self = this;
        var showCount = this._showCount;

        if (this._showMessagePool.length < showCount) {
            this._getCommentData(function (data) {

                if (self._commentDataList.length > self._showMessagePool.length) {
                    var msg = self._createMessageByData(data);
                    msg.show();
                    // console.log("缓存"+self._commentDataList.length,"对象池"+self._showMessagePool.length);
                    setTimeout(function () {
                        self.createMessage();
                    }, getCreateDelayTime());
                }
            });
        }
    };

    /**
     * 创建一个临时的消息，不在弹幕显示列表中
     * @param data
     */
    p.createTempMessage = function (data) {
        //  debugger;
        //console.log(arguments); 
        var msg = cm.messageFactory.create();

        msg.init2(data.content, this);
        msg.tempShow();

        var replyTarget = data.replyTarget;

        msg.selected = true;

        var self = this;

        var comment = this.comment;

        var alert = cm.OCBAlert.show(function () {
            // debugger;
            var commentReplyView = comment.replyView;
            var id = "";
            var draft = commentReplyView.commentDraft;
            if (replyTarget) {
                id = replyTarget.objectId;
            } else {
                id = comment.pageTplId;
            }
            draft[id] = "";
            //派发打开评论开关事件
            if (window.dms) {
                var event = dms.createEvent("comment:open:handle", this.okButton);
                dms.dispatcher.dispatchEvent(event);
            }
            self._sendMsgToServer(msg, data.content, replyTarget);
            comment.lockBarrageEvent = false;
            msg.$dom.remove();
        }, function () {
            //派发关闭评论开关事件
            if (window.dms && !comment.isShowBarrage) {
                var event = dms.createEvent("comment:close:handle", this.cancelButton);
                dms.dispatcher.dispatchEvent(event);
            }
            msg.hide();
            comment.lockBarrageEvent = false;
            var event = cm.createEvent("reply:error");
            comment.dispatchEvent(event);
        });
    };
    /**
     * 将回复的消息发送到服务器
     * @param msg 评论消息对象cm.MessageView
     * @param replyText 回复的文本
     * @param replayTarget 回复的评论消息对象，如果有
     * @private
     */
    p._sendMsgToServer = function (msg, replyText, replyTarget) {
        var option = {};


        var content = this._createContent(msg, replyText, replyTarget);

        var comment = this.comment;

        var replyUserId;

        if (replyTarget) {
            option.comment_id = replyTarget.objectId;
            option.belong_comment = replyTarget.objectId;
            replyUserId = replyTarget.comment_uid;
        } else {
            option.comment_id = comment.tplId;
            option.belong_comment = "";
            replyUserId = comment.tplUserId;
        }


        option.comment_type = replyTarget ? 2 : comment.tplType;
        option.comment_content = JSON.stringify(content);
        option.data_site = comment.dateSite;

        option.belong_tpl = comment.tplId;
        //不需要 byzhao
//        option.belong_tplpage = comment.pageTplId;
        var user = cm.commentModel.getCurrentUser();

        var self = this;

        cm.commentModel.replyComment(option, function (data) {
            var obj = self._createData(data.objectId, JSON.stringify(content));
            /*  self._commentDataList.push(obj); //unshift

             if(self._commentDataList.length == 1){
             msg.hide();
             msg = self._createMessageByData(obj);
             msg.show(false);
             }*/
            // debugger;
            // self._commentDataList.unshift(obj);

            msg.hide();
            msg = self._createMessageByData(obj);
            msg.show(true);

            setTimeout(function () {
                self._commentDataList.push(obj);
                // console.log('加入缓存');
            }, 2000);
            //如果评论的对象不是自己，则发送推送消息
            if (replyUserId && replyUserId != user.id) {
                var effecturl = comment.tplShareImage;
                effecturl = effecturl.replace(/^(AV:)/g, "");
                var msg_recid = comment.tplUserId;
//                     console.log(msg_recid);
                var msg_obj = {
                    "tpl_id": comment.tplId,
                    "pageid": comment.pageTplId,
                    "tpl_user": comment.tplUserId,
                    "effecturl": effecturl
                };
                var mt_content = {
                    "content": replyText
                }
                var pushoPtions = {
                    "msg_recid": msg_recid,//接收者ID
                    "msg_type": 2,//消息类型 评论2 赞3
                    "tpl_name": comment.tpl_name,
                    "msg_obj": JSON.stringify(msg_obj), //消息对象 包括  作品ID(tpl_id) 作品页ID(pageid) 作者ID (tpl_user)作品页效果图(effecturl)  类型josn对象
                    "mt_content": JSON.stringify(mt_content) //包括 原评论 评论对评论  评论对评论作者姓名 id
                };
                sns_data.msgAdd(pushoPtions, function (data) {
                    if (comment._selectedData) {
                        var uname = comment._selectedData.comment_uid_pointer.user_nick;
                        var old_content = JSON.parse(option.comment_content);
                        old_content = old_content.content;
                        var conment_content = {
                            "content": replyText,
                            "old_content": old_content,
                            "uname": uname,
                            "old_userId": comment._selectedData.comment_uid
                        };
                        pushoPtions.mt_content = JSON.stringify(conment_content);
                        sns_data.msgAdd(pushoPtions, function (data) {
                            // console.log("评论对评论推送消息成功");
                        }, function (error) {
                            // console.log("评论对评论推送消息失败");
                        });
                    }
                }, function (error) {
                    console.log(error);
                });
            }

            var event = cm.createEvent("reply:success");
            comment.dispatchEvent(event);
        }, function () {
            var event = cm.createEvent("reply:network:error");
            comment.dispatchEvent(event);
        });
    };

    /**
     * 创建一个消息数据对象
     * @param objectId
     * @param content
     * @returns {{}}
     * @private
     */
    p._createData = function (objectId, content) {
        var user = cm.commentModel.getCurrentUser();
        var obj = {};
        obj.comment_content = content;
        obj.comment_uid_pointer = {
            user_nick: user.get("user_nick"),
            user_pic: user.get("user_pic") || cm.Const.defaultUserPic
        };
        obj.objectId = objectId;
        obj.comment_uid = user.id;

        //console.log(obj);
        return obj;
    };

    /**
     * 创建内容json对象
     * @param msg cm.MessageView
     * @param replyText 回复的文本
     * @param replyTarget 回复的对象
     * @returns {{}}
     * @private
     */
    p._createContent = function (msg, replyText, replyTarget) {

        var content = {};
        var effecturl = this.comment.tplShareImage;
        effecturl = effecturl.replace(/^(AV:)/g, "");
        if (replyTarget) {
            var old_content = JSON.parse(replyTarget.comment_content)
            content.uid = replyTarget.comment_uid;
            content.uname = replyTarget.comment_uid_pointer.user_nick;
            content.old_content = old_content.content;
        }
        content.content = replyText;
        content.tpl_effect = effecturl;

        var container = this.dom;
        var width = container.clientWidth;
        var left = msg.$dom.css("left");
        var top = msg.$dom.css("top");

        var imgPos = false;

        if (parseInt(left) > width / 2) {
            imgPos = true;
        }

        content.imgPos = imgPos;
        content.x = left;
        content.y = top;
        return content;
    };

    /**
     * 根据数据对象创建评论消息
     * @param data
     * @returns {*}
     * @private
     */
    p._createMessageByData = function (data) {
        //console.log(data.toJSON());
        var msgView = cm.messageFactory.create();
        var o;
        if (data.toJSON) {
            o = data.toJSON();
            //预防没有用户对象，报错的情况下
            if (data.get("comment_uid_pointer")) {
                o.comment_uid_pointer.user_nick = data.get("comment_uid_pointer").get("user_nick");
                o.comment_uid_pointer.user_pic = data.get("comment_uid_pointer").get("user_pic");
            }
        } else {
            o = data;
        }
        msgView.init(o, this);
        return msgView;
    };

    /**
     * 从弹幕池中删除评论消息
     * @param messageView
     */
    p.removeMessage = function (messageView) {
        if (messageView.dom.parentNode) {
            messageView.dom.parentNode.removeChild(messageView.dom);
        }
        this._removeMsgFormPool(messageView);
        //console.log(this._showMessagePool);
        var self = this;
        if (this._isShow) {
            setTimeout(function () {
                self.createMessage();
            }, getCreateDelayTime());
        }
    };

    p.showTempMessage = function (messageView) {
        this.dom.appendChild(messageView.dom);
    };

    p._removeMsgFormPool = function (msg) {
        var index;
        if ((index = this._showMessagePool.indexOf(msg)) >= 0) {
            this._showMessagePool.splice(index, 1);
        }
    };

    /**
     * 将评论消息添加到弹幕池
     * @param msgView
     */
    p.addMessage = function (msgView) {

        //console.log(msgView.dom);
        //console.log(msg.$dom.addClass("comment-msg-show"));
        if (msgView.dom.parentNode != this.dom) {
            if (msgView.dom.parentNode) {
                msgView.dom.parentNode.removeChild(this.dom)
            }

            this.dom.appendChild(msgView.dom);
        }

        //console.log(msgView);
        this._showMessagePool.push(msgView);

        if (!this._paused) {
            msgView.play();
        }

    };

    /**
     * 暂停弹幕动画
     */
    p.paused = function () {
        if (!this._paused) {
            this._paused = true;
            //console.log("puased");
            //console.log();
            //this.animationFn(null,true);
            for (var i = 0; i < this._showMessagePool.length; i++) {
                this._showMessagePool[i].stop && this._showMessagePool[i].stop();
            }
        }
    };

    /**
     * 开始弹幕动画
     */
    p.start = function () {
        if (this._paused) {
            this._paused = false;
            this.createMessage();
            for (var i = 0; i < this._showMessagePool.length; i++) {
                this._showMessagePool[i].start && this._showMessagePool[i].start();
            }
            //this.animationFn(null);
        }
    };


    /**
     * 清除数据，回到初始状态
     */
    p.clear = function () {
        this.commentIndex = 0;
        this._currentIndex = 0;
        this._commentDataList = [];
        this._isDataLoading = false;
        //this._isShow = false;
        this.hide();
        var i;

        //this.animationFn(null,true);
        var msg;
        //for(i = this._showMessagePool.length - 1;i >= 0;i--){
        //    msg = this._showMessagePool[i];
        //    msg.hide();
        //    msg.clear();
        //}

        while (this._showMessagePool.length > 0) {
            msg = this._showMessagePool.shift();
            msg.hide();
            msg.clear();
        }

        this._showMessagePool = [];

        this._loadOver = false;
        if (this._timer) {
            window.clearTimeout(this._timer);
            this._timer = null;
        }

        /**弹幕是否暂停**/
        this._paused = true;
        this.comment.barrageContainer.innerHTML = "";
    };

    cm.BarrageView = BarrageView;
})(cm);
// 文件名称: cm.CommentView
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:23
// 描    述: cm.CommentView
(function(cm){
    /**
     *
     * @param obj barrageContainer:评论容器,replyContainer:回复容器
     *            tplId:作品模板id,pageTplId:页模板id
     * @constructor
     */
    var Comment = function(){
        cm.EventDispatcher.call(this);
        /**
         * 弹幕容器
         * @type {Element|*}
         */
        this.barrageContainer = document.createElement("div");

        this.barrageContainer.className = "comment-barrage-container";

        this._lockBarrageEvent = false;

        this.barrageView = null;
        this.replyView = null;
        //是否显示弹幕
        this.isShowBarrage = true;
        //{
        //    "comment_uid_pointer": {
        //    "className": "_User",
        //        "__type": "Pointer",
        //        "updatedAt": "2015-08-11T04:29:37.608Z",
        //        "createdAt": "2015-02-13T18:54:52.481Z",
        //        "objectId": "54de487ce4b04fce1963c459",
        //        "user_nick": "dsfs"
        //},
        //    "comment_uid": "54de487ce4b04fce1963c459",
        //    "createdAt": "2015-09-09T06:50:10.499Z",
        //    "updatedAt": "2015-09-09T06:50:10.499Z",
        //    "comment_content": "{\"uid\":\"54de487ce4b04fce1963c459\",\"content\":\"dsfdsfdsfds\",\"imgPos\":false,\"x\":\"320px\",\"y\":\"504px\"}",
        //    "objectId": "55efd6a2ddb263b55d926887"
        //}
        this._selectedTarget = null;

        this._selectedData = null;

        this._lockPraise = false;
    };

    cm.inherit(Comment,cm.EventDispatcher);

    var p = Comment.prototype;

    p.init = function(config){ 
        config = config || {};
        /**
         * 作品id
         * @type {string|*}
         */
        this.tplId = config.tplId;
        /**
         * 页id
         * @type {string|*}
         */
         //作品名称
        this.tpl_name = config.tplName;

        this.pageTplId = config.pageTplId;

        this.tplUserId = config.tplUserId;
        this.tplShareImage = config.tplShareImage;

        this.tplType = config.tplType || 0;
        this.dataSite = config.dataSite || 0;
    };

    Object.defineProperty(p,"lockBarrageEvent",{
        get : function(){
            return this._lockBarrageEvent;
        },
        set : function(value){
            this._lockBarrageEvent = value;
        }
    });

    p._initEvent = function(){

    };

    /**
     * 打开弹幕
     */
    p.openBarrage = function(){
        if(!this.barrageView){
            this.barrageView = new cm.BarrageView(this);
        }
        this.isShowBarrage = true;
        this.barrageView.show();
    };

    /**
     * 关闭弹幕
     */
    p.closeBarrage = function(){
        if(!this.barrageView){
            return;
        }
        this.isShowBarrage = false;
       // this.barrageView.clear();
        this.barrageView.hide();

    };

    p._createReplyFn = function(e){
        var data = {
            replyTarget : e.replyTarget,
            content : e.replyText
        };
        this.lockBarrageEvent = true;
        var isShow = this.isShowBarrage;
        this.openBarrage();
        this.isShowBarrage = isShow;
        this.barrageView.createTempMessage(data);
    };

    /**
     * 显示评论视图
     * @param target
     */
    p.showReply = function(target){ 
        if(!this.replyView){
            this.replyView = new cm.ReplyView(this);
        }
        this.replyView.removeAllEventListeners("create:reply");
        this.replyView.on("create:reply",this._createReplyFn,this);
        this.replyView.show(target);
        this.replyView.$inputText.focus();
    };

    /**
     * 隐藏评论视图
     */
    p.hideReply = function(){
        if(!this.replyView){
            return;
        }
        //console.log("df")
        this.replyView.removeAllEventListeners("create:reply");
        this.replyView.hide();
    };

    /**
     * 回收comment组件
     */
    p.recover = function(){
        //     console.log('评论回收',this.barrageView);
        // this.barrageView.paused();
        this.lockBarrageEvent = false;
        this.selectedObject = null;
        this.selectedTarget = null;
        this.hideReply();
        this._selectedData = null;
        this.closeBarrage();
        cm.OCBAlert.hide();
        //console.log('');
        if(this.barrageView) this.barrageView.clear();
       
        if(this.barrageContainer && this.barrageContainer.parentNode){
            this.barrageContainer.parentNode.removeChild(this.barrageContainer);
        }

        this.removeAllEventListeners("barrage:click");
        this.removeAllEventListeners("reply:success");
        this.removeAllEventListeners("reply:error");

        this.onDestroy();
    };

    Object.defineProperty(p,"selectedTarget",{
        get : function(){
            return this._selectedTarget;
        },
        set : function(value){
            this._selectedTarget = value;
        }
    });

    Object.defineProperty(p,"selectedData",{
        get : function(){
            return this._selectedData;
        },
        set : function(value){
            this._selectedData = value;
        }
    });

    /**
     * 将弹幕加到parent上
     * @param parent dom元素
     */
    p.appendTo = function(parent){
        if(this.barrageContainer){
            if(this.barrageContainer.parentNode){
                this.barrageContainer.parentNode.removeChild(this.barrageContainer);
            }
            parent.appendChild(this.barrageContainer);
        }
    };

    /**
     * 移除弹幕
     */
    p.remove = function(){
        if(this.barrageContainer){
            if(this.barrageContainer.parentNode){
                this.barrageContainer.parentNode.removeChild(this.barrageContainer);
            }
        }
    };

    /**
     * 获取点赞数 如果选中了评论消息，则查询评论消息的点赞数，否则查询页的点赞数
     * @param cb 回调
     */
    p.getPraiseCount = function(cb){
        var commentId = this._getCommentId();
        var param = this._getIdParam(commentId,cb);
        cm.commentModel.getPraiseCount(param.id,function(count){
            if(param.cb){
                param.cb(count);
            }
        });
    };

    /**
     * 获取评论数 如果选中了评论消息，则查询评论消息的评论数，否则查询页的评论数
     * @param cb 回调,如果 commentId为空，可以只传此参数，则默认查询页的评论数
     */
    p.getCommentCount = function(cb){
        var commentId = this._getCommentId();
        var fieldName = cm.isString(commentId) ? "comment_id" : "belong_tplpage";
        var param = this._getIdParam(commentId,cb);

        cm.commentModel.getCommentCount(fieldName,param.id,function(count){
            if(param.cb){
                param.cb(count);
            }
        });
    };

    p._getCommentId = function(){
        if(this.selectedData){
            return this.selectedData.objectId;
        }
        return null;
    };

    /**
     * 查询点赞状态 如果选中了评论消息，则查询评论消息的点赞状态，否则查询页的点赞状态
     * @param cb
     */
    p.getPraiseStatus = function(cb){
        var commentId = this._getCommentId();
        var param = this._getIdParam(commentId,cb);
        cm.commentModel.getPraiseStatus(param.id,function(bool){
            if(param.cb){
                param.cb(bool);
            }
        });
    };

    /**
     * 点赞 如果选中了评论消息，则对评论消息点赞，否则对页点赞
     * @param cb 回调返回 0已点赞，1未点赞
     */
    p.praise = function(cb){ 
        if(this._lockPraise){
            return;
        }
        this._lockPraise = true;
        //评论id
        var id = this._getCommentId();

        var like_type = id?2:1;

        var param = this._getIdParam(id,cb);
        var option = {};
        option.id = param.id;
        option.tplType = like_type;//this.tplType;
        option.dataSite = this.dataSite;
        option.pageid=this.pageTplId;
        option.commentId = id || "";

        var commentUid = "";
        if(this.selectedData){
            commentUid = this.selectedData.comment_uid;
        }

        option.commentUid = commentUid;

        option.tplId = this.tplId;

        var self = this;

        cm.commentModel.praise(option,function(status){
            
            if(status == 'like'){
                var msgObj = {
                    "tpl_id":option.tplId,
                    "pageid":self.pageTplId,
                    "tpl_user":self.tplUserId,
                    "effecturl": self.tplShareImage
                };
                var op = {
                    "msg_recid":self.tplUserId,
                    "msg_type":1,
                    "tpl_name":self.tpl_name,
                    "msg_obj":JSON.stringify(msgObj),
                    "mt_content":""
                };
                cm.commentModel.msgPush(op,function(data){
                    if(commentUid){
                        /*op = {
                            "msg_recid":commentUid,
                            "msg_type":1,
                            "msg_obj":JSON.stringify(self.msgObj),
                            "mt_content":""
                        };*/
                        op.msg_recid = commentUid;
                        op.old_userId = commentUid; 
                        cm.commentModel.msgPush(op, function(data){
                            // console.log("推送赞---",uid);
                        },function(error){
                            console.log(error);
                        });
                    }
                },function(){});
            }
            self._lockPraise = false;
            param.cb((status == 'like'));
        },function(){
            self._lockPraise = false;
        });
    };

    p._getIdParam = function(cid,cb){
        var id;
        if(cm.isString(cid)){
            id = cid;
        }else if(cm.isFunction(cid)){
            cb = cid;
            id = this.pageTplId;
        }else{
            id = this.pageTplId;
        }

        return {
            id : id,
            cb : cb
        };
    };

    p.onDestroy = function(){};

    Comment.create = function(config){ 
        var comment = cm.commentFactory.create();
        comment.init(config);
        return comment;
    };

    cm.Comment = Comment;

    //p
})(cm);
// 文件名称: cm.MessageView
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:23
// 描    述: 评论消息类,对应屏幕上显示的一条消息
(function(cm){
    var messageTpl =
        "<div class='comment-message-photo'></div>" +
        "<div class='comment-message-content'></div>";

    var MouseEvent = window.MouseEvent;
    var TouchEvent = window.TouchEvent;

    /**
     * 评论消息类
     * @constructor
     */
    var MessageView = function(){
        cm.BaseView.call(this);
        /**
         * 评论消息所对应的数据对象
         * @type {null}
         * @private
         */
        this._messageData = null;

        /**
         * 弹幕容器视图
         * @type {null}
         * @private
         */
        this._barrageView = null;

        this.id = cm.getNewID();

        this.animating = false;

        /**
         * 弹幕的dom元素
         * @type {*|jQuery|HTMLElement}
         */
        this.$dom = $("<div>");
        this.dom = this.$dom[0];

        //this.dom.id = "message-" + this.id;

        this.$dom.addClass("comment-message");

        //this.dom.style.position = "absolute";

        /**
         * 弹幕的选中状态
         * @type {boolean}
         * @private
         */
        this._selected = false;

        /**
         * 弹幕显示状态
         * @type {boolean}
         * @private
         */
        this._isShow = false;

        this.offset = {
            x : 0,
            y : 0
        };

        this.dom.innerHTML = messageTpl;
        //消息内容容器
        this.$content = this.$dom.find(".comment-message-content");
        this.$photoContainer = this.$dom.find(".comment-message-photo");
        //头像容器
        //this.$photo = this.$dom.find(".comment-message-photo > div");
    };

    cm.inherit(MessageView,cm.BaseView);

    var p = MessageView.prototype;

    p.init = function(data,barrageView){
        this.selected = false;
        this._messageData = data;
        this._barrageView = barrageView;
        this.on("message:animation:end",this._animationEnd,this);
        this._reset();
    };

    /**
     * 返回对象的数据
     * @returns {null|*}
     */
    p.getMessageData = function(){
        return this._messageData;
    };

    p.init2 = function(data,barrageView){
        this.$content.html(data);
        this._barrageView = barrageView;
        var user = cm.commentModel.getCurrentUser();
        //var p = data.comment_uid_pointer;
        var src = user.get("user_pic") || cm.Const.defaultUserPic;
        /*this.$photoContainer.css({
            backgroundImage : "url("+src+")"
        });*/ 
        this.$photoContainer.html('<img src="'+src+'" >');
        var size = this._getStageSize();
        var randomPosition = cm.getRandomPosition(size);
        this.$dom.css({
            left : randomPosition.x,
            top : randomPosition.y,
            "pointer-events":"auto"
        });

        this._resetPos();
    };

    p._getStageSize = function(){
        var container = this._barrageView.dom;
        var stageWidth = container.clientWidth;
        var stageHeight = container.clientHeight;
        return {width:stageWidth,height:stageHeight};
    };

    p.play = function(){ 
        var self = this;
        this.$dom.off("webkitAnimationEnd animationEnd").on("webkitAnimationEnd animationEnd",function(){
            self.$dom.off("webkitAnimationEnd animationEnd");
            //console.log("adfasdf");
            self.dispatchEvent("message:animation:end");
        });
        //this.$dom.css("animation-play-state","running").css("-webkit-animation-play-state","running");
    };

    p.stop = function(){ 
       // console.log('stop');
        //this.$dom.css("animation-play-state","paused").css("-webkit-animation-play-state","paused");
        this.$dom.off("webkitAnimationEnd animationEnd");

    };

    /**
     * 设置当前对象是否可以拖动
     */
    Object.defineProperty(p,"isDragging",{
        get : function(){
            return !!this._isDragging;
        },
        set : function(value){
            this._isDragging = value;
            if(value){
                this._addEvent();
            }else{
                this._removeEvent();
            }
        }
    });



    /**
     * 设置当前对象的选中状态
     */
    Object.defineProperty(p,"selected",{
        get : function(){
            return this._selected;
        },
        set : function(value){
            this._selected = value;
            if(value){
                this.$content.css({
                    border : "3px solid #37cb37",
                    borderRadius : ""
                });
            }else{
                this.$content.css({
                    border : "0"
                });
            }
        }
    });

    /**
     * 消息的动画完成时调用的函数
     * @private
     */
    p._animationEnd = function(){
        this.hide();
    };
    
    /**
     * 重新刷新视图
     * @private
     */
    p._reset = function(){
        var data = this._messageData;
        if(data){
            var content = data.comment_content;
            content = JSON.parse(content);
            this.$content.html(content.content);
            var p = data.comment_uid_pointer;
//	    var src = p.user_pic || cm.Const.defaultUserPic;
	    //预防没有用户对象的情况，出错
            var src = cm.Const.defaultUserPic;
            if(p && p.user_pic){
                src = p.user_pic ;
            }
            /*this.$photoContainer.css({
                backgroundImage : "url("+src+")"
            });*/ 
            this.$photoContainer.html('<img src="'+src+'">');
            if(content.x == null || content.y == null){
                var size = this._getStageSize();
                var rp = cm.getRandomPosition(size);
                content.x = rp.x;
                content.y = rp.y;
            }

            this.$dom.css({
                left : content.x,
                top : content.y
            });

            this._resetPos();
        }
    };

    /**
     * 根据当前的位置来刷新头像的位置
     * @private
     */
    p._resetPos = function(){
        var left = this.$dom.css("left");
        var domWidth = this.$dom.width();

        //console.log(left,top);
        var size = this._getStageSize();
        //console.log(stageWidth);
        if((parseInt(left) + domWidth) > size.width){
            this.$dom.removeClass("comment-message-left").addClass("comment-message-right");
        }else{
            this.$dom.removeClass("comment-message-right").addClass("comment-message-left");
        }
    };

    /**
     * 显示消息
     * @param isAnimate 显示时是否调用动画
     * @param animateClass 动画类
     */
    p.show = function(isAnimate,animateClass){
        if(this._isShow){
            return;
        }

        this._isShow = false;
        this._animateClass = animateClass || "comment-msg-show";

        this.$dom.removeClass(this._animateClass);
        this.$dom.off("webkitAnimationEnd animationEnd");
        //if(isAnimate){
        var content = this._messageData.comment_content;
        content = JSON.parse(content);
            this.$dom.addClass(this._animateClass);
        //}

        this.play();

        if(this._barrageView){
            //将消息加入弹幕池
            this._barrageView.addMessage(this);
        }
    };

    p.tempShow = function(){
        if(this._isShow){
            return;
        }

        this._isShow = false;
        //this.$dom.addClass("comment-msg-show");
        this.isDragging = true;
        this._barrageView.showTempMessage(this);
    };

    /**
     * 隐藏视图
     */
    p.hide = function(){
        this.off("message:animation:end",this._animationEnd);
        this.$dom.removeClass("comment-msg-show");
        this._removeEvent();
        this.selected = false;
        //console.log(this.);
        //console.log("remove");
        if(this._barrageView){
            //从弹幕池移除消息
            //console.log("remove"+ " - " + this.id);
            this._barrageView.removeMessage(this);
            this._barrageView = null;
            this._messageData = null;
            this.onHide();
        }else{
            this.$dom.remove();
        }
    };
    //添加拖动事件
    p._addEvent = function(){
        var self = this;

        this.$dom.on("touchstart mousedown",function(e){
            self._downHandle(e);
        });

        this.$dom.on("touchmove mousemove",function(e){
            self._moveHandle(e);
        });

        this.$dom.on("touchend mouseup",function(e){
            self._upHandle(e);
        });
    };

    p._downHandle = function(e){
        this._isDown = true;
        var point = this._mapPoint(e);

        this.offset.x = point.x - this.dom.offsetLeft;
        this.offset.y = point.y - this.dom.offsetTop;
    };

    p._mapPoint = function(e){
        var pageX = 0;
        var pageY = 0;
        var oE = e.originalEvent || e;
        if(oE.constructor === TouchEvent){
            var touch = oE.touches[0];
            pageX = touch.pageX;
            pageY = touch.pageY;
        }else if(oE.constructor === MouseEvent){
            pageX = oE.pageX;
            pageY = oE.pageY;
        }

        return {
            x : pageX,
            y : pageY
        };
    };

    p._moveHandle = function(e){
        e.preventDefault();
        e.stopPropagation();
        if(!this._isDown){
            return;
        }
        var point = this._mapPoint(e);
        var x = point.x - this.offset.x;
        var y = point.y - this.offset.y;

        var left = this.$dom.css("left");
        var top  = this.$dom.css("top");

        var width = this.$content.width(); //+ this.$photoContainer.width();
        var height = this.$dom.height();
 
        
        var container = this._barrageView.dom;
        var stageWidth = container.clientWidth;
        var stageHeight = container.clientHeight;
         

        if(x  < 0){
            x = 10;  //0
            this.$dom.removeClass("comment-message-right").addClass("comment-message-left");
        }else if(x  + width + 80 > stageWidth){
            x= stageWidth * 0.4 - 10; 
            this.$dom.removeClass("comment-message-left").addClass("comment-message-right");
        }

        if(y < 0){
            y = 10; //0
        }else if(y + height + 50> stageHeight){
            y = stageHeight - height - 50;   //stageHeight - height;
        } 
        //移动的时候不能移动到弹幕开关的下面
       /* if((x + width) > (stageWidth - 110) && y < 150){
            x = stageWidth - 110 - width;
        }*/
        this.$dom.css({
            left : x + "px",
            top  : y + "px"
        });
 
    };

    p._upHandle = function(e){
        //e.preventDefault();
        this._isDown = false;
    };

    p.clear = function(){
        /*this.$photoContainer.css({
            backgroundImage : "none"
        });*/
        this.$photoContainer.html('');
        this.hide();
        this.$dom.removeClass(this._animateClass);
        this.$dom.off("webkitAnimationEnd animationEnd");
        this._animateClass = null;
        //console.log('去除动画');
    };

    p._removeEvent = function(){
        this.$dom.off("touchstart mousedown");
        this.$dom.off("touchmove mousemove");
        this.$dom.off("touchend mouseup");
    };

    p.onHide = function(){};

    cm.MessageView = MessageView;
})(cm);
// 文件名称: cm.ReplyView
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:17
// 描    述: 回复视图
(function(cm){
    //模板
    var tpl =
        '<div class="comment-reply-txt"> ' +
            '<div class="comment-table-cell">' +
                '<svg version="1.1" class="img" xmlns="http://www.w3.org/2000/svg" ' +
                'xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="50px" ' +
                'height="50px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" ' +
                'xml:space="preserve">' +
                '<path fill="#f4c600" d="M511.999488 744.967304c-245.74903 0-444.967304-199.219297-444.967304-444.967304 ' +
                '0-245.748007 199.218274-444.967304 444.967304-444.967304 245.748007 0 444.967304 ' +
                '199.219297 444.967304 444.967304C956.966793 545.74903 757.747495 744.967304 511.999488 ' +
                '744.967304zM350.072539 533.502102c42.302455 0 76.596516-40.735773 76.596516-90.985224s-' +
                '34.293037-90.985224-76.596516-90.985224c-42.303478 0-76.596516 40.735773-76.596516 ' +
                '90.985224S307.769061 533.502102 350.072539 533.502102zM509.523087 43.310803c-202.848964 ' +
                '4.956895-237.351779 171.880649-237.351779 171.880649 272.15033-223.125777 474.705606 0 474.705606 ' +
                '0C704.721815 43.273964 517.45678 43.273964 509.523087 43.310803zM674.365436 351.532677c-42.303478 ' +
                '0-76.597539 40.735773-76.597539 90.985224s34.294061 90.985224 76.597539 90.985224c42.302455 0 ' +
                '76.596516-40.735773 76.596516-90.985224S716.667891 351.532677 674.365436 351.532677z" transform="translate(0, 812) ' +
                'scale(1, -1)"></path>' +
                '</svg>' +
            '</div> ' +
            '<div class="comment-table-cell">' +
                '<input class="comment-reply-input" type="text" placeholder="我要评论(限50字)" maxlength="50"/>' +
            '</div> ' +
            '<div class="comment-table-cell">' +
             '<span class="comment-sent-btn cno-send-btn"></span>'+
            '</div>' +
        '</div>';

    /**                '<button type="button" class="comment-sent-btn" style="color: rgb(204, 204, 204);">发送</button>' +

     * 回复的视图对象，继承自EventDispatcher，视图对象可以派发事件
     * @param comment cm.Comment对象
     * @constructor
     */
    var ReplyView = function(comment){
        cm.EventDispatcher.call(this);
        /**
         * 视图对象的dom元素
         * @type {*|jQuery|HTMLElement}
         */
        this.$dom = $("<div>");
        //备注取消缩放的时候，添加half-zoom
        this.$dom.addClass("comment-reply-container half-zoom");
//        this.$dom.addClass("comment-reply-container");
        this.$dom.html(tpl);

        /**
         * 显示视图时，此为黑色半透明背景
         * @type {*|jQuery|HTMLElement}
         */
        this.maskLayer = $("<div>");
        this.maskLayer.addClass("comment-mask-parent");

        this.comment = comment;
         /**
         * 存放对应页面的输入评论草稿
         */
        this.commentDraft={};

        /**
         * 发送按钮
         */
        this.$sendButton = this.$dom.find(".comment-sent-btn");

        /**
         * 回复文本框
         */
        this.$inputText = this.$dom.find(".comment-reply-input");

        this._isShow = false; 


        this._replyTarget = null;

        this.dom = this.$dom[0];
    };

    cm.inherit(ReplyView,cm.EventDispatcher);

    var p = ReplyView.prototype;

    /**
     * 显示视图
     * @param target 此为回复的对象，当用户点击了弹幕上的cm.MessageView对象，那么target就是
     * cm.MessageView 对象的 messageData
     */
    p.show = function(target){
         var id="";
         if(target){
              id = target.objectId; 
         }else{
              id= this.comment.pageTplId;
         }

        if(this._isShow){
            return;
        }

        /**
         * 显示视图时添加事件
         */
        this._addEvent();
        this._replyTarget = target;
        this._isShow = true;
        document.body.appendChild(this.maskLayer[0]);
        document.body.appendChild(this.dom);
        this.$inputText.focus();
        var draft =this.commentDraft[id];
        var draftTxt = draft?draft:"";
        this.$inputText.val(draftTxt);
    };

    p._addEvent = function(){
        var self = this;
        this.$sendButton.on("tap",function(e){
            e.preventDefault();
            e.stopPropagation();
            self._sendFn();
        });

        this.maskLayer.on("tap",function(e){
            e.preventDefault();
            e.stopPropagation();
            self.hide();
            var event = cm.createEvent("reply:error");
                self.comment.dispatchEvent(event);
        });

        this.$inputText.on("input",function(){
            self._checkText();
        });
    };

    /**
     * 发送填写的评论
     * @private
     */
    p._sendFn = function(){
        var val = this.$inputText.val();
        val = val.replace(/(^\s*)|(\s*$)/g,"");
        if(val.length == 0){
            return;
        }
        val = val.replace(/(<)+|(>)+/g,function($1,$2){return $1 == "<" ?"&lt;":"&gt;";});

        if(val.length > 50){
            val = val.substring(0,50);
        } 
        /**
         * 创建一个“创建回复”事件,可以由外部的当前对象监听此类型事件进行处理
         * @type {*|Event}
         */
        var event = cm.createEvent("create:reply",null);
        //如果点击了评论，刚回复此评论，将此数据挂载到事件上
        event.replyTarget = this._replyTarget;
        //回复的文本
        event.replyText = val;
        //派发事件
        this.dispatchEvent(event);
        //隐藏评论视图
        this.hide();
    };
    /*
     * 检查文本是否为空
     * @private
     */
    p._checkText = function(){ 
        var id=""; 
        var val = this.$inputText.val();
        val = val.replace(/ /g,"");
         
        if(val.length == 0){
            this.$sendButton.removeClass("cyes-send-btn").addClass("cno-send-btn");
        }else{
            this.$sendButton.removeClass("cno-send-btn").addClass("cyes-send-btn");
        } 
        if(this._replyTarget){
              id= this._replyTarget.objectId; 
        }else{
              id =this.comment.pageTplId;  
        }
         this.commentDraft[id]= val;
    };

    p._removeEvent = function(){
        this.$sendButton.off("tap");
        this.maskLayer.off("tap");
        this.$inputText.off("change keyup paste cut");
    };

    p.hide = function(){
        //console.log("hide");
        if(!this._isShow){
            return;
        }

        var self = this;
        setTimeout(function(){
            self._isShow = false;
        },100);
        this._removeEvent();

        this._replyTarget = null;

        this.$inputText.val("").blur();

        document.body.removeChild(this.maskLayer[0]);
        document.body.removeChild(this.dom);
    };

    cm.ReplyView = ReplyView;
})(cm);
// 文件名称: cm.commentFactory
//
// 创 建 人: chenshy
// 创建日期: 2015/9/8 16:29
// 描    述: cm.commentFactory
(function(cm){
    var commentFactory = cm.objectPoolFactory(function(){
        var comment = new cm.Comment();

        comment.onDestroy = function(){
            commentFactory.recover(comment);
        };

        return comment;
    });

    cm.commentFactory = commentFactory;
})(cm);
// 文件名称: cm.MessageFactory
//
// 创 建 人: chenshy
// 创建日期: 2015/8/20 15:25
// 描    述: cm.MessageFactory
(function(cm){
    var messageFactory = cm.objectPoolFactory(function(){
        var message = new cm.MessageView();
        //console.log("create msg",message.id);
        message.onHide = function(){
            messageFactory.recover(message);
        };

        return message;
    });

    cm.messageFactory = messageFactory;
})(cm);
// 文件名称: cm.OCAlert
//
// 创 建 人: chenshy
// 创建日期: 2015/9/7 14:14
// 描    述: cm.OCBAlert
(function(cm){

    var tpl =
        '<div class="ocbalert-cancel">取 消</div>'+
        '<div class="ocbalert-ok">完 成</div>' ;

    cm.OCBAlert = function(){
        this.$dom = $("<div>");
        this.$dom.css({
            zIndex:9999
        });

        this.$dom.html(tpl);
        //备注取消缩放的时候，添加half-zoom
//        this.$dom.addClass("comment-ocbalert");
        this.$dom.addClass("comment-ocbalert half-zoom");
        this.dom = this.$dom[0];

        this._isShow = false;

        this.okButton = this.$dom.find(".ocbalert-ok")[0];
        this.cancelButton = this.$dom.find(".ocbalert-cancel")[0];

        var self = this;

        this.$dom.on("tap",function(e){
            self._clickFn(e);
        });

    };

    var p = cm.OCBAlert.prototype;

    p.show = function(okFn,cancelFn){
        if(this._isShow){
            return;
        }
        this._isShow = true;
        document.body.appendChild(this.dom);
        this._okFn = okFn;
        this._cancelFn = cancelFn;
    };

    p.hide = function(){
        if(!this._isShow){
            return;
        }
        document.body.removeChild(this.dom);
        this._isShow = false;
        this._okFn = null;
        this._cancelFn = null;
    };

    p._clickFn = function(e){
        e.preventDefault();
        e.stopPropagation();

        var target = e.target;
        if(target === this.okButton){
            if(this._okFn){
               this._okFn();
            }
        }else{
            if(this._cancelFn){
                this._cancelFn(); 
            } 
        }

        this.hide();
    };

    var alert;

    cm.OCBAlert.show = function(okFn,cancelFn){
        if(!alert){
            alert = new cm.OCBAlert();
        }
        alert.show(okFn,cancelFn);
        return alert;
    };

    cm.OCBAlert.hide = function(){
        if(!alert){
            return;
        }
        alert.hide();
        return alert;
    };
})(cm);